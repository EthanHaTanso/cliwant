# AI 세무 어시스턴트 기능 정의서 (Feature Specification)

## 문서 개요

이 문서는 AI 세무 어시스턴트의 기능을 정의합니다.

**Related Documents**:
- MVP 제안서: [AI_Tax_Assistant.md](../../AI_Tax_Assistant.md)
- 상세 정책서: [detailed-policy.md](./detailed-policy.md)
- JTBD: [USER_001_2026-02-03.md](../../../../User%20Discover/User%20Interview/USER_001_2026-02-03.md)

---

## US-001: Transaction Tracking - 거래 내역 자동 수집

### 사용자 스토리

사용자로서, 팝빌 API를 통해 은행 계좌 거래 내역을 자동으로 수집하여, 수동 입력 없이 모든 거래가 tracking되기를 원합니다.

### Acceptance Criteria

#### AC-001-01: 팝빌 API 연동

- 사용자가 초기 설정 시 팝빌 계정 정보 입력 (API Key, Secret Key)
- **다수 은행 계좌 등록**: 기업은행, 우리은행, 국민은행, 하나은행 중 여러 계좌 동시 등록 가능
- 각 계좌별 팝빌 "빠른조회 서비스" 신청 여부 확인
- 연결 테스트 실행 후 계좌별 성공/실패 표시

**초기 설정 데이터**:

| 필드 | 타입 | 필수 여부 | 설명 | 예시 |
|------|------|-----------|------|------|
| popbill_api_key | String | 필수 | 팝빌 API Key | "abc123..." |
| popbill_secret_key | String | 필수 | 팝빌 Secret Key | "xyz789..." |
| accounts | Array | 필수 | 은행 계좌 목록 | [{"bank": "기업은행", "account_number": "123-456-789"}, {"bank": "우리은행", "account_number": "987-654-321"}] |
| query_interval | String | 필수 | 조회 주기 | "daily" (매일 오전 6시) |

#### AC-001-02: 배치 기반 자동 조회

- **매일 오전 6시** 모든 등록된 계좌에 대해 팝빌 API 일괄 조회 (배치 처리)
- 전날 발생한 거래 내역 수집 (각 은행별로 병렬 조회)
- 신규 거래 감지 시 시스템 DB에 자동 저장 (계좌 정보 포함)
- 중복 거래 자동 제거 (transaction_id 기반)
- **계좌 간 이체 자동 감지 및 제외**:
  - 동일 금액, 동일 시간대 입금/출금 패턴 분석
  - 중복 카운트 방지 (예: 기업은행 → 우리은행 이체는 1건으로 간주)

#### AC-001-03: 거래 데이터 저장

- 팝빌 API에서 받은 거래 정보를 Transaction 테이블에 저장:

| 필드 | 타입 | 필수 여부 | 설명 | 예시 |
|------|------|-----------|------|------|
| transaction_id | String | 필수 | 거래 고유 ID | "2026-02-05-IBK-AWS-001" |
| bank_name | String | 필수 | 은행명 | "기업은행" |
| account_number | String | 필수 | 계좌번호 (마스킹) | "***-**-789" |
| date | Date | 필수 | 거래 날짜 | "2026-02-05" |
| time | Time | 필수 | 거래 시간 | "14:30:00" |
| amount | Number | 필수 | 금액 | 50000 |
| type | String | 필수 | 입금/지출 | "지출" |
| counterparty | String | 선택 | 거래 상대방 | "AWS Korea" |
| bank_memo | String | 선택 | 은행 앱 메모 | "AWS 서버비" |
| is_internal_transfer | Boolean | 필수 | 계좌 간 이체 여부 | false |
| status | String | 필수 | 처리 상태 | "pending_enrichment" |
| created_at | DateTime | 필수 | 생성 시간 | "2026-02-05T14:35:00Z" |

#### AC-001-04: Enrichment 필요 여부 판단

- 신규 거래 감지 시 과거 패턴 검색:
  - 동일 거래처 + 유사 금액 (±10%) + 동일 주기 → "recurring" 플래그
  - 처음 보는 거래 → "needs_enrichment" 플래그
- 플래그에 따라 질문 Queue에 추가 또는 자동 분류

#### AC-001-05: 에러 처리

- 팝빌 API 연결 실패 시:
  - 에러 로그 기록
  - 유저에게 슬랙 알림: "팝빌 API 연결 실패, 설정 확인 필요"
  - 3회 재시도 후 관리자 알림
- 은행 계좌 잔액 불일치 시:
  - 경고 로그 기록 (실제 잔액과 DB 잔액 비교)

---

## US-002: Smart Questions - 세법 기반 스마트 질문

### 사용자 스토리

사용자로서, 신규 거래 발생 시 세법/회계법에 근거한 구체적인 질문을 받아, 세무사가 필요로 하는 맥락 정보를 빠르게 제공하고 싶습니다.

### Acceptance Criteria

#### AC-002-01: 질문 생성 로직

- Enrichment가 필요한 거래를 Queue에서 가져옴
- AI (OpenAI/Claude API)에게 거래 정보 + 세법/회계법 컨텍스트 전달
- AI가 3-7개 질문 생성:
  - 계정 분류 관련 (개발비 vs 운영비 등)
  - 정기성 확인 (반복 여부, 주기)
  - 거래 관계 (다른 거래와 연관성)
  - 세무 처리 (세액공제 대상 여부 등)
  - **증빙 서류 확인** (계산서/영수증 수령 여부)
  - **파일 업로드** (서류 첨부 가능 여부)

**질문 생성 Prompt 예시**:
```
거래 정보:
- 계좌: 기업은행
- 날짜: 2026-02-05
- 금액: 50,000원 지출
- 거래처: AWS Korea
- 유저 메모: "AWS 서버비"

과거 패턴:
- 2026-01-15: AWS 50,000원 (메모: "AWS 서버비", 기업은행)
- 2025-12-15: AWS 50,000원 (기업은행)

세법 컨텍스트:
- IT 스타트업 개발비는 연구개발비 세액공제 대상 가능
- 정기 지출은 패턴 누락 확인 필요
- 클라우드 비용은 통신비 또는 외주용역비로 분류
- 세액공제 대상은 계산서 필수

질문 생성:
1. 이 지출은 개발비인가요, 운영비인가요?
2. 정기 지출인가요? (매월 반복?)
3. 다른 AWS 지출과 관련 있나요? (예: 1월 20일 100,000원 추가 지출)
4. 📎 계산서/영수증 받으셨나요?
5. 📤 파일 업로드 가능하신가요?
```

#### AC-002-02: 슬랙 알림 발송

- **매일 오전 9시** 배치로 전날 거래에 대한 질문을 모아서 슬랙 발송
- 슬랙 메시지 포맷:

```
📊 어제 거래 3건 확인 필요 (예상 소요: 2분)

1️⃣ 2026-02-05 14:30, AWS 50,000원 지출 (기업은행)
유저 메모: "AWS 서버비"

💬 질문:
Q1. 이 지출은 개발비인가요, 운영비인가요?
[개발비] [운영비] [기타]

Q2. 정기 지출인가요? (매월 반복?)
[네, 매월 반복] [아니오, 일회성]

Q3. 다른 거래와 관련 있나요?
[1월 20일 AWS와 관련] [별개] [모르겠음]

Q4. 📎 계산서/영수증 받으셨나요?
[네, 받았어요] [아니오, 안 받았어요] [요청할 예정]

Q5. 📤 파일 업로드 가능하신가요?
[파일 업로드 →] [나중에 업로드] [업로드 불가]

[답변 완료 →]
```

#### AC-002-03: 슬랙 인터랙티브 응답 처리

- 사용자가 버튼 클릭 시 응답 수집
- 모든 질문에 답변 완료 시 EnrichedContext 생성
- 응답 데이터:

| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| transaction_id | String | 거래 ID | "2026-02-05-AWS-001" |
| question_id | String | 질문 ID | "Q1" |
| answer | String | 사용자 답변 | "개발비" |
| answered_at | DateTime | 답변 시간 | "2026-02-06T09:05:00Z" |

#### AC-002-04: 리마인더 처리

- 24시간 내 미답변 시 리마인더 슬랙 메시지 발송
- 3일 후에도 미답변 시:
  - "답변 없이 넘어가기" 옵션 제공
  - Transaction status를 "pending_manual_review"로 변경
  - 월말 문서에 "확인 필요" 섹션에 포함

#### AC-002-05: 파일 업로드 처리

- 슬랙 "파일 업로드" 버튼 클릭 시 파일 선택 모달 제공
- 지원 파일 형식: PDF, JPG, PNG (10MB 이하)
- 업로드된 파일은 **유저 로컬 파일 시스템에 저장**:
  - 저장 경로: `~/ai-tax-assistant/documents/`
  - 파일명 자동 생성: `invoice_{transaction_id}_{date}.{ext}`
  - 로컬 DB에는 파일 경로만 저장
- EnrichedContext에 파일 경로 저장 (예: `/Users/sanhalee/ai-tax-assistant/documents/invoice_2026-02-05_AWS.pdf`)
- OCR (v1.1 이후):
  - 이미지 파일에서 텍스트 자동 추출
  - 금액, 날짜, 거래처 자동 매칭 및 검증

#### AC-002-06: 텍스트 입력 지원

- 객관식 외에 "기타" 선택 시 텍스트 입력 모달 제공
- 음성 입력 (v1.1 이후):
  - 슬랙 음성 메시지로 답변
  - Speech-to-Text API로 변환
  - 텍스트 답변으로 처리

---

## US-003: Enriched Context Storage - 맥락 정보 저장

### 사용자 스토리

사용자로서, 질문에 답변한 맥락 정보가 체계적으로 저장되어, 월말 문서 생성 시 활용되기를 원합니다.

### Acceptance Criteria

#### AC-003-01: EnrichedContext 데이터 구조

- Transaction에 1:1로 연결된 EnrichedContext 생성:

| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| id | String | Enriched Context ID | "EC-2026-02-05-001" |
| transaction_id | String | 거래 ID | "2026-02-05-IBK-AWS-001" |
| user_memo | String | 유저 간단 메모 | "AWS 서버비" |
| category | String | 세부 카테고리 | "개발비 - 클라우드 운영" |
| is_recurring | Boolean | 정기 지출 여부 | true |
| frequency | String | 반복 주기 | "월 1회, 매월 15일" |
| related_transaction_ids | Array | 관련 거래 ID 목록 | ["2026-01-15-IBK-AWS", "2025-12-15-IBK-AWS"] |
| tax_notes | String | 세무 처리 메모 | "연구개발비 세액공제 대상 가능성" |
| account_classification | String | 계정 분류 | "경비 - 통신비" |
| ai_generated_summary | String | AI 생성 요약 | "AWS EC2 인스턴스 월 사용료, 개발 환경 운영비" |
| **documents** | **Object** | **증빙 서류 정보** | **{"invoice_received": true, "files": ["invoice_2026-02-05_AWS.pdf"], "status": "✅ 준비 완료"}** |
| created_at | DateTime | 생성 시간 | "2026-02-06T09:05:00Z" |
| updated_at | DateTime | 수정 시간 | "2026-02-06T09:05:00Z" |

**documents 객체 구조**:

| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| invoice_received | Boolean | 계산서/영수증 수령 여부 | true |
| files | Array | 업로드된 파일 경로 목록 | ["invoice_2026-02-05_AWS.pdf"] |
| status | String | 증빙 상태 | "✅ 준비 완료" / "⚠️ 준비 필요" / "❌ 증빙 불가" |

#### AC-003-02: AI 요약 생성

- 유저 답변을 바탕으로 AI가 세무사용 상세 설명 자동 생성
- Prompt 예시:

```
Input:
- 거래: AWS 50,000원 지출
- 유저 메모: "AWS 서버비"
- 유저 답변:
  - Q1: 개발비 - 운영비
  - Q2: 정기 지출, 매월 15일
  - Q3: 1월/12월과 동일 패턴

Output (세무사용 요약):
"AWS EC2 인스턴스 월 사용료, 개발 환경 운영비로 사용. 매월 15일 정기 지출 패턴 (1월, 12월 동일). 계정 분류: 경비-통신비. 연구개발비 세액공제 검토 필요."
```

#### AC-003-03: 관련 거래 자동 링크

- 유저가 "관련 있음" 선택 시 related_transaction_ids에 추가
- 반대 방향 링크도 자동 생성 (양방향 관계)
- 예: A가 B와 관련 → B에도 A 자동 추가

#### AC-003-04: 과거 패턴 학습

- 3개월 이상 동일 패턴 반복 시:
  - is_recurring = true 자동 설정
  - 다음 달부터 질문 생략, 자동 분류
  - 단, 금액이 ±20% 이상 차이 나면 재질문

---

## US-004: Monthly Document Generation - 월말 문서 자동 생성

### 사용자 스토리

사용자로서, 매월 부가세 신고 3일 전에 모든 거래 내역과 맥락 정보가 포함된 종합 문서가 자동 생성되어, 10분만 리뷰하고 세무사에게 발송하고 싶습니다.

### Acceptance Criteria

#### AC-004-01: 문서 생성 트리거

- 매월 25일 오전 9시 자동 트리거 (부가세 신고 3일 전 기준)
- 또는 유저가 수동으로 "문서 생성" 버튼 클릭

#### AC-004-02: 데이터 수집 및 분류

- 해당 월의 모든 Transaction + EnrichedContext 조회
- 자동 분류:
  - **정기 지출**: is_recurring = true인 거래
  - **비정기 지출**: is_recurring = false인 거래
  - **확인 필요**: status = "pending_manual_review"인 거래

#### AC-004-03: 거래 관계 자동 파악

- related_transaction_ids를 기반으로 거래 그룹 생성
- 예:
  ```
  그룹 1: 마케팅 조사 관련
  - 2월 10일: 200,000원 (인터뷰 섭외비)
  - 2월 12일: 150,000원 (장소 대관비)
  - 2월 15일: 300,000원 (응답자 리워드)
  ```

- AI Prompt로 거래 간 관계 설명 생성:

```
Input:
- 거래 1: 2월 10일, 200,000원, "인터뷰 섭외비"
- 거래 2: 2월 12일, 150,000원, "장소 대관비"
- 거래 3: 2월 15일, 300,000원, "응답자 리워드"
- 관계: 모두 related

Output:
"위 3건은 모두 2월 신규 기능 출시 사전 유저 리서치와 관련. 인터뷰 진행을 위한 일련의 지출로, 마케팅비-조사비로 통합 분류."
```

#### AC-004-04: 문서 구조 생성

- 마크다운 형식 문서 자동 생성:

```markdown
# [사용자명] 2월 입출금 내역 요약 (총 48건)

## 📊 월별 요약

- 총 입금: 5,000,000원 (10건)
- 총 지출: 3,200,000원 (38건)
- 순 현금흐름: +1,800,000원
- 사용 계좌: 기업은행, 우리은행

## 📋 증빙 서류 체크리스트

| 상태 | 건수 | 설명 |
|------|------|------|
| ✅ 준비 완료 | 42건 | 계산서/영수증 수집 완료 |
| ⚠️ 준비 필요 | 4건 | 계산서 미수령, 요청 필요 |
| ❌ 증빙 불가 | 2건 | 개인 간 거래 (증빙 없음) |

**준비 필요 항목**:
1. 2월 10일 - 유저 인터뷰 섭외비 (200,000원) - 계산서 요청 중
2. 2월 12일 - 인터뷰 장소 대관비 (150,000원) - 영수증 미수령
...

## 🔄 정기 지출 (30건)

### [카테고리 1: AWS 클라우드 서비스]

**거래 내역:**
- 계좌: 기업은행
- 날짜: 2월 15일
- 금액: 50,000원
- 설명: AWS EC2 인스턴스 월 사용료, 개발 환경 운영비

**패턴:**
- 반복 주기: 매월 15일
- 과거 이력: 1월 15일, 12월 15일 동일

**계정 분류:**
- 경비 - 통신비

**세무 처리:**
- 연구개발비 세액공제 검토 필요

**증빙:**
- ✅ 계산서 첨부 (invoice_2026-02-05_AWS.pdf)

---

### [카테고리 2: 직원 급여]
...

## ⚡ 비정기 지출 (18건)

### [그룹 1: 마케팅 조사 관련]

**거래 관계:**
위 3건은 모두 2월 신규 기능 출시 사전 유저 리서치와 관련. 인터뷰 진행을 위한 일련의 지출.

**거래 내역:**
1. 2월 10일: 200,000원 - 유저 인터뷰 섭외비 (우리은행)
2. 2월 12일: 150,000원 - 인터뷰 장소 대관비 (우리은행)
3. 2월 15일: 300,000원 - 설문 응답자 리워드 (기업은행)

**계정 분류:**
- 마케팅비 - 조사비

**증빙:**
- ⚠️ 계산서 준비 필요 (섭외비 영수증 미수령)

---

## ⚠️ 확인 필요 (미답변 거래)

- 2월 20일: 500,000원 지출 (거래처: 불명)
  - 상태: 맥락 정보 없음, 수동 확인 필요
```

#### AC-004-05: 문서 저장

- 생성된 문서를 MonthlyDocument 테이블에 저장:

| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| id | String | 문서 ID | "MD-2026-02" |
| user_id | String | 사용자 ID | "user-001" |
| month | String | 해당 월 | "2026-02" |
| total_transactions | Number | 총 거래 건수 | 48 |
| total_income | Number | 총 입금 | 5000000 |
| total_expense | Number | 총 지출 | 3200000 |
| document_markdown | Text | 마크다운 문서 | "# 2월 입출금..." |
| document_version | Number | 버전 | 1 |
| status | String | 상태 | "generated" |
| generated_at | DateTime | 생성 시간 | "2026-02-25T09:00:00Z" |
| reviewed_at | DateTime | 리뷰 완료 시간 | null |
| sent_to_accountant_at | DateTime | 세무사 발송 시간 | null |

#### AC-004-06: 슬랙 알림

- 문서 생성 완료 시 슬랙 알림:

```
📄 2월 부가세 신고 문서 준비 완료!

총 48건 거래 정리됨
- 정기 지출: 30건 (자동 분류)
- 비정기 지출: 18건 (상세 맥락 포함)
- 확인 필요: 0건

[문서 확인하기 →] (예상 소요: 10분)
```

---

## US-005: Document Review & Edit - 문서 리뷰 및 수정

### 사용자 스토리

사용자로서, 자동 생성된 월말 문서를 웹 대시보드에서 빠르게 훑어보고, 필요한 부분만 수정하여, 10분 내에 세무사 발송 준비를 완료하고 싶습니다.

### Acceptance Criteria

#### AC-005-01: 웹 대시보드 접속

- 슬랙 알림의 "문서 확인하기" 링크 클릭
- 웹 브라우저에서 문서 리뷰 페이지 열림
- 로그인 인증 (팝빌 계정 또는 별도 로그인)

#### AC-005-02: 문서 표시

- 마크다운 문서를 렌더링하여 보기 좋게 표시
- 섹션별 접기/펼치기 (Collapsible)
- 카테고리별 색상 구분:
  - 정기 지출: 파란색
  - 비정기 지출: 주황색
  - 확인 필요: 빨간색

#### AC-005-03: 인라인 수정

- 각 거래 항목에 "수정" 버튼
- 클릭 시 인라인 편집 모드:
  - 설명 텍스트 수정
  - 계정 분류 변경 (드롭다운)
  - 세무 처리 메모 추가/수정
- 수정 완료 시 자동 저장, EnrichedContext 업데이트

#### AC-005-04: 거래 그룹 재구성

- 비정기 지출에서 거래 간 관계 수정 가능
- 드래그 앤 드롭으로 거래를 다른 그룹으로 이동
- 새 그룹 생성 가능

#### AC-005-05: 엑셀 미리보기

- "엑셀 미리보기" 버튼 클릭
- 세무사 전달용 엑셀 파일 미리보기:

| 날짜 | 금액 | 거래처 | 카테고리 | 설명 | 계정 분류 | 세무 처리 |
|------|------|--------|----------|------|-----------|-----------|
| 2월 5일 | -50,000 | AWS Korea | 정기 | AWS EC2... | 경비-통신비 | 연구개발비... |

#### AC-005-06: 리뷰 완료

- "리뷰 완료" 버튼 클릭
- MonthlyDocument status를 "reviewed"로 변경
- reviewed_at 타임스탬프 기록

---

## US-006: Accountant Delivery - 세무사 전달

### 사용자 스토리

사용자로서, 리뷰 완료된 월말 문서를 클릭 한 번으로 세무사에게 이메일로 발송하고 싶습니다.

### Acceptance Criteria

#### AC-006-01: 세무사 정보 설정

- 초기 설정 시 세무사 이메일 등록
- 세무사 선호 포맷 선택:
  - [x] 엑셀 (xlsx)
  - [ ] CSV
  - [ ] PDF

#### AC-006-02: 엑셀 파일 생성

- MonthlyDocument의 document_markdown을 파싱
- 엑셀 파일 생성:
  - Sheet 1: 거래 내역 (위 표 형식)
  - Sheet 2: 카테고리별 요약
  - Sheet 3: 세무 처리 메모

#### AC-006-03: 이메일 자동 발송

- "세무사에게 발송" 버튼 클릭
- 이메일 템플릿:

```
수신: [세무사 이메일]
제목: [사용자명] 2월 부가세 신고 자료

안녕하세요,

2월 입출금 내역을 첨부합니다.

- 총 거래 건수: 48건
- 총 입금: 5,000,000원
- 총 지출: 3,200,000원

상세 내역은 첨부 파일을 확인해주세요.
별도 문의사항 있으시면 연락 부탁드립니다.

감사합니다.

[자동 생성 메시지]
```

- 첨부: `[사용자명]_2026년2월_입출금내역.xlsx`

#### AC-006-04: 발송 확인

- 이메일 발송 성공 시:
  - MonthlyDocument status를 "sent"로 변경
  - sent_to_accountant_at 타임스탬프 기록
  - 슬랙 알림: "세무사에게 문서 발송 완료!"
- 실패 시:
  - 에러 로그 기록
  - 슬랙 알림: "이메일 발송 실패, 수동 발송 필요"
  - 엑셀 다운로드 링크 제공

#### AC-006-05: 수동 다운로드

- "엑셀 다운로드" 버튼 제공
- 유저가 직접 다운로드 후 세무사에게 전달 가능

---

## UI/UX 사양

### 컴포넌트 재사용

- **TransactionCard**: 거래 1건 표시 카드 (Real-time Q&A, Monthly Document에서 재사용)
- **SlackNotification**: 슬랙 메시지 템플릿 컴포넌트
- **DocumentEditor**: 마크다운 인라인 편집기

### 반응형 디자인

- 웹 대시보드: 데스크톱 우선 (1280px 이상 최적화)
- 슬랙: 모바일 최적화 (버튼 크기, 터치 인터랙션)
- v1.1: PWA로 모바일 앱 지원

### 접근성

- 키보드 네비게이션 지원
- 스크린 리더 호환
- 색맹 대응 (색상 외 아이콘으로도 구분)

---

## API 명세

### POST /api/v1/transactions/sync

팝빌 API에서 거래 내역 동기화

**Request**:
```json
{
  "user_id": "user-001",
  "start_date": "2026-02-01",
  "end_date": "2026-02-28"
}
```

**Response**:
```json
{
  "status": "success",
  "new_transactions": 15,
  "total_transactions": 48
}
```

---

### POST /api/v1/enrichment/questions

신규 거래에 대한 스마트 질문 생성

**Request**:
```json
{
  "transaction_id": "2026-02-05-AWS-001"
}
```

**Response**:
```json
{
  "questions": [
    {
      "id": "Q1",
      "text": "이 지출은 개발비인가요, 운영비인가요?",
      "options": ["개발비", "운영비", "기타"]
    },
    {
      "id": "Q2",
      "text": "정기 지출인가요?",
      "options": ["네, 매월 반복", "아니오, 일회성"]
    }
  ]
}
```

---

### POST /api/v1/enrichment/answers

유저 답변 저장 및 Enriched Context 생성

**Request**:
```json
{
  "transaction_id": "2026-02-05-AWS-001",
  "answers": [
    {"question_id": "Q1", "answer": "개발비"},
    {"question_id": "Q2", "answer": "네, 매월 반복"}
  ]
}
```

**Response**:
```json
{
  "status": "success",
  "enriched_context_id": "EC-2026-02-05-001"
}
```

---

### POST /api/v1/documents/generate

월말 문서 자동 생성

**Request**:
```json
{
  "user_id": "user-001",
  "month": "2026-02"
}
```

**Response**:
```json
{
  "status": "success",
  "document_id": "MD-2026-02",
  "total_transactions": 48,
  "generated_at": "2026-02-25T09:00:00Z"
}
```

---

### GET /api/v1/documents/{document_id}

문서 조회

**Response**:
```json
{
  "id": "MD-2026-02",
  "month": "2026-02",
  "document_markdown": "# 2월 입출금 내역...",
  "status": "generated"
}
```

---

### PUT /api/v1/documents/{document_id}

문서 수정 (인라인 편집)

**Request**:
```json
{
  "transaction_id": "2026-02-05-AWS-001",
  "updates": {
    "description": "AWS EC2 인스턴스 월 사용료 (수정됨)",
    "account_classification": "경비-통신비"
  }
}
```

**Response**:
```json
{
  "status": "success",
  "document_version": 2
}
```

---

### POST /api/v1/documents/{document_id}/send

세무사에게 이메일 발송

**Request**:
```json
{
  "accountant_email": "accountant@example.com",
  "format": "xlsx"
}
```

**Response**:
```json
{
  "status": "success",
  "sent_at": "2026-02-28T10:00:00Z"
}
```

---

## 에러 처리

### 팝빌 API 연결 실패

- **조건**: 팝빌 API Key 오류 또는 "빠른조회 서비스" 미신청
- **처리**:
  - 슬랙 알림: "팝빌 API 연결 실패. 설정을 확인해주세요."
  - 웹 대시보드에 설정 가이드 링크 표시
- **메시지**: "은행 '빠른조회 서비스' 신청 필요 (5-10분 소요)"

### AI API 오류

- **조건**: OpenAI/Claude API 호출 실패 (429 Too Many Requests 등)
- **처리**:
  - 3회 재시도 (exponential backoff)
  - 실패 시 간소화 버전 생성 (AI 요약 없이 기본 정보만)
  - 슬랙 알림: "문서 생성 일부 실패. 수동 보완 권장."

### 이메일 발송 실패

- **조건**: SMTP 서버 오류 또는 세무사 이메일 주소 오류
- **처리**:
  - 슬랙 알림: "이메일 발송 실패. 엑셀 파일을 다운로드하여 수동 발송해주세요."
  - 엑셀 다운로드 링크 제공

---

## 성능 요구사항

- 팝빌 API 배치 조회 (4개 계좌): 1분 이내 완료
- 스마트 질문 생성: 5초 이내 (AI API 응답)
- 월말 문서 생성: 50건 기준 30초 이내
- 웹 대시보드 로딩: 3초 이내
- 파일 업로드: 10MB 파일 기준 5초 이내

---

## 보안 요구사항

### 완전 로컬 아키텍처 (금융중개업 규제 회피)

- **모든 민감 데이터는 유저 로컬 환경에서 관리**:
  - 팝빌 API Key: 유저 디바이스의 암호화된 설정 파일에 저장 (AES-256)
  - 계좌번호: 로컬 DB에 암호화 저장
  - 거래 내역: 로컬 SQLite/PostgreSQL DB
  - 증빙 서류: 유저 디바이스의 지정된 폴더 (예: `~/ai-tax-assistant/documents/`)

- **클라우드 최소 사용**:
  - AI API (OpenAI/Claude): 거래 정보 전송 시 계좌번호/개인정보 마스킹
  - 슬랙 알림: 거래 금액과 메모만 전송, 계좌번호 미포함
  - 이메일: 세무사 발송 시에만 사용, TLS 암호화

- **데이터 주권**:
  - 유저가 언제든 데이터 백업/삭제 가능
  - 서비스 중단 시에도 로컬 DB 접근 가능

---

## 향후 개선 사항

1. **세무사 직접 연동**: 세무사 웹페이지 API 연동하여 자동 업로드
2. **음성 입력 지원**: 슬랙 음성 메시지로 질문 답변
3. **팀 협업**: 다수 유저가 각자 거래 설명, CFO가 최종 리뷰
4. **모바일 앱**: PWA → 네이티브 앱 전환
5. **세무사 피드백 루프**: 세무사 재질문 내용 시스템에 반영하여 질문 품질 향상
6. **OCR 자동 처리**: 업로드된 영수증/계산서 이미지에서 금액, 날짜 자동 추출 및 검증
7. **세법/회계법 자동 업데이트**: 법령 변경 시 자동 감지 및 질문 로직 업데이트, 국세청 API 연동
